name: PR Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

# Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend Tests & Lint
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Run Ruff linter
        run: |
          poetry run ruff check . --output-format=github
        continue-on-error: false

      - name: Run Ruff formatter check
        run: |
          poetry run ruff format --check .
        continue-on-error: false

      - name: Run mypy type checking
        run: |
          poetry run mypy app --ignore-missing-imports
        continue-on-error: true  # Type errors shouldn't block for now

      - name: Run pytest with coverage
        run: |
          poetry run pytest \
            --cov=app \
            --cov-report=xml \
            --cov-report=term \
            --cov-fail-under=80 \
            -v
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

      - name: Security scan with Bandit
        run: |
          poetry run bandit -r app -ll -f json -o bandit-report.json || true
          poetry run bandit -r app -ll
        continue-on-error: true

  frontend-tests:
    name: Frontend Tests & Lint
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend-outreachpass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend-outreachpass/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Run TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Run tests with coverage
        run: npm run test:ci || true
        env:
          CI: true

      - name: Build verification
        run: npm run build
        env:
          NODE_ENV: production

  terraform-validation:
    name: Terraform Validation
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.0'

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: false

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Run TFLint
        run: |
          tflint --init
          tflint --format compact
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities for now

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        if: always()

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, terraform-validation, security-scan]
    if: always()

    steps:
      - name: PR Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              backend: '${{ needs.backend-tests.result }}',
              frontend: '${{ needs.frontend-tests.result }}',
              terraform: '${{ needs.terraform-validation.result }}',
              security: '${{ needs.security-scan.result }}'
            };

            const statusIcon = (status) => {
              return status === 'success' ? '✅' : status === 'failure' ? '❌' : '⚠️';
            };

            const body = `## PR Validation Results

            | Check | Status |
            |-------|--------|
            | Backend Tests & Lint | ${statusIcon(results.backend)} ${results.backend} |
            | Frontend Tests & Lint | ${statusIcon(results.frontend)} ${results.frontend} |
            | Terraform Validation | ${statusIcon(results.terraform)} ${results.terraform} |
            | Security Scanning | ${statusIcon(results.security)} ${results.security} |

            ${results.backend === 'failure' || results.frontend === 'failure' ? '⚠️ **Some checks failed. Please review the logs and fix issues before merging.**' : '✅ **All checks passed! Ready for review.**'}

            ---
            *Automated validation by GitHub Actions*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
